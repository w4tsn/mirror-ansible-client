---

stages:
  - base-test
  - test

.fedora:
  stage: test
  variables:
    GIT_STRATEGY: clone
    PLAYBOOK: base.yml
  before_script:
    - 'sudo dnf install -y git ansible unzip'
    - 'sed -i "s/^become_ask_pass = .*/become_ask_pass = False/" ansible.cfg'
    - 'ansible-galaxy collection install -r requirements.yml'
  script:
    - 'env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v $PLAYBOOK --syntax-check'
    - 'env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v $PLAYBOOK'
    - env ANSIBLE_FORCE_COLOR=1 ansible-playbook -v $PLAYBOOK | tee ansible.log
    - >
      grep -q 'changed=0.*failed=0' ansible.log
      && (echo 'Idempotence test: pass' && exit 0)
      || (echo 'Idempotence test: fail' && exit 1)

f33-base:
  extends: .fedora
  stage: base-test
  image: docker.io/library/fedora:33

f34-base:
  extends: .fedora
  stage: base-test
  image: docker.io/library/fedora:34

f33-base-extension:
  extends: .fedora
  image: docker.io/library/fedora:33
  variables:
    PLAYBOOK: "base.yml base-extension.yml"
  needs:
    - f33-base

f34-base-extension:
  extends: .fedora
  image: docker.io/library/fedora:34
  variables:
    PLAYBOOK: "base.yml base-extension.yml"
  needs:
    - f34-base

f33-development:
  extends: .fedora
  image: docker.io/library/fedora:33
  variables:
    PLAYBOOK: "base.yml gnome.yml development.yml"
  needs:
    - f33-base

f34-development:
  extends: .fedora
  image: docker.io/library/fedora:34
  variables:
    PLAYBOOK: "base.yml gnome.yml development.yml"
  needs:
    - f34-base
